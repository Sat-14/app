# billsreminder.kv
#:import dp kivy.metrics.dp
#:import FadeTransition kivy.uix.screenmanager.FadeTransition
#:import colors kivy.utils.get_color_from_hex
#:import ButtonBehavior kivy.uix.behaviors.button.ButtonBehavior
#:import FloatLayout kivy.uix.floatlayout.FloatLayout

<ScreenManager>:
    transition: FadeTransition(duration=0.2)

# Color palette
<ColorPalette>:
    primary: colors('#4361ee')
    secondary: colors('#3a0ca3')
    accent: colors('#f72585')
    success: colors('#4cc9f0')
    danger: colors('#e63946')
    light: colors('#f8f9fa')
    dark: colors('#212529')
    gray: colors('#6c757d')
    light_gray: colors('#e9ecef')

# Custom widgets
<RoundedButton@Button>:
    background_color: 0, 0, 0, 0
    background_normal: ''
    background_down: ''
    canvas.before:
        Color:
            rgba: self.background_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(10),]
        Color:
            rgba: colors('#ffffff') if self.background_color[0] > 0.7 else colors('#ffffff')
        Line:
            rounded_rectangle: self.x, self.y, self.width, self.height, dp(10)
            width: 1.5

# FIX: Re-adding the properties that were missing
<IconButton@Button>:
    size_hint: None, None
    size: dp(40), dp(40)
    background_color: 0, 0, 0, 0
    bg_color: [0, 0, 0, 0]
    text_color: [1, 1, 1, 1]
    color: root.text_color
    canvas.before:
        Color:
            rgba: root.bg_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(20),]
    
<CustomTextInput@TextInput>:
    multiline: False
    padding: dp(15), dp(15)
    background_color: colors('#ffffff')
    foreground_color: colors('#212529')
    cursor_color: colors('#4361ee')
    cursor_width: dp(2)
    size_hint_y: None
    height: dp(55)
    font_size: sp(16)
    canvas.before:
        Color:
            rgba: colors('#dee2e6')
        Line:
            width: 1.2
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(8))

<CardLayout@BoxLayout>:
    orientation: 'vertical'
    padding: dp(15)
    spacing: dp(10)
    size_hint_y: None
    height: self.minimum_height
    canvas.before:
        Color:
            rgba: colors('#ffffff')
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12),]
        Color:
            rgba: colors('#e9ecef')
        Line:
            width: 0.8
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))

# Bill Item Widget
<BillItem>:
    orientation: 'horizontal'
    size_hint_y: None
    height: dp(110)
    padding: dp(10)
    spacing: dp(15)
    canvas.before:
        Color:
            rgba: colors('#ffffff')
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12),]
        Color:
            rgba: colors('#e9ecef')
        Line:
            width: 0.8
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))

    BoxLayout:
        orientation: 'vertical'
        size_hint_x: 0.7
        spacing: dp(5)
        
        Label:
            id: bill_name
            text: 'Bill Name'
            font_size: sp(18)
            bold: True
            text_size: self.width, None
            halign: 'left'
            valign: 'middle'
            height: dp(25)
            color: colors('#212529')
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(25)
            spacing: dp(10)
            
            Label:
                id: bill_amount
                text: '₹0'
                font_size: sp(18)
                text_size: self.width, None
                halign: 'left'
                valign: 'middle'
                color: colors('#4361ee')
                bold: True
            
            Widget:
                size_hint_x: None
                width: dp(1)
                canvas:
                    Color:
                        rgba: colors('#e9ecef')
                    Rectangle:
                        pos: self.pos
                        size: self.size
        
        Label:
            id: bill_due_date
            text: 'Due: --'
            font_size: sp(14)
            text_size: self.width, None
            halign: 'left'
            valign: 'middle'
            color: colors('#6c757d')
    
    BoxLayout:
        orientation: 'vertical'
        size_hint_x: 0.3
        spacing: dp(10)
        
        Label:
            id: status_label
            text: 'PENDING'
            font_size: sp(12)
            bold: True
            color: colors('#e63946')
            text_size: self.width, None
            halign: 'center'
            valign: 'middle'
            canvas.before:
                Color:
                    rgba: colors('#ffe5e7') if status_label.text == 'PENDING' else colors('#e8f8f5')
                RoundedRectangle:
                    pos: self.x, self.y
                    size: self.size
                    radius: [dp(10),]
        
        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(5)
            
            IconButton:
                text: '✓'
                bg_color: colors('#4cc9f0') if root.bill_data.get('is_paid', False) else colors('#e9ecef')
                text_color: colors('#ffffff') if root.bill_data.get('is_paid', False) else colors('#6c757d')
                on_release: root.mark_as_paid()
            
            IconButton:
                text: '✎'
                bg_color: colors('#e9ecef')
                text_color: colors('#4361ee')
                on_release: root.edit_bill()
            
            IconButton:
                text: '×'
                bg_color: colors('#e9ecef')
                text_color: colors('#e63946')
                on_release: root.delete_bill()

# Login Screen
<LoginScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(30)
        spacing: dp(30)
        canvas.before:
            Color:
                rgba: colors('#f8f9fa')
            Rectangle:
                pos: self.pos
                size: self.size
        
        Label:
            text: 'Welcome Back'
            font_size: sp(28)
            bold: True
            color: colors('#212529')
            size_hint_y: None
            height: dp(40)
            text_size: self.width, None
            halign: 'center'
        
        CardLayout:
            orientation: 'vertical'
            spacing: dp(15)
            
            CustomTextInput:
                id: email_input
                hint_text: 'Email address'
                input_type: 'mail'
            
            CustomTextInput:
                id: password_input
                hint_text: 'Password'
                password: True
            
            RoundedButton:
                text: 'Login'
                size_hint_y: None
                height: dp(50)
                background_color: colors('#4361ee')
                color: colors('#ffffff')
                bold: True
                font_size: sp(16)
                on_release: app.login(email_input.text, password_input.text)
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(40)
            padding: dp(10), 0
            spacing: dp(5)
            
            Label:
                text: "Don't have an account?"
                color: colors('#6c757d')
                font_size: sp(14)
            
            Button:
                text: "Sign Up"
                background_color: 0, 0, 0, 0
                color: colors('#4361ee')
                bold: True
                font_size: sp(14)
                size_hint_x: None
                width: self.texture_size[0]
                on_release: root.manager.current = 'register'

# Register Screen
<RegisterScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        canvas.before:
            Color:
                rgba: colors('#f8f9fa')
            Rectangle:
                pos: self.pos
                size: self.size
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(50)
            
            IconButton:
                text: '←'
                bg_color: colors('#e9ecef')
                text_color: colors('#4361ee')
                font_size: sp(20)
                on_release: root.manager.current = 'login'
            
            Label:
                text: 'Create Account'
                font_size: sp(22)
                bold: True
                color: colors('#212529')
                size_hint_x: 0.8
                text_size: self.width, None
                halign: 'center'
        
        ScrollView:
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(20)
                size_hint_y: None
                height: self.minimum_height
                padding: dp(10)
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    CustomTextInput:
                        id: name_input
                        hint_text: 'Full Name'
                    
                    CustomTextInput:
                        id: email_input
                        hint_text: 'Email'
                        input_type: 'mail'
                    
                    CustomTextInput:
                        id: phone_input
                        hint_text: 'Phone Number'
                        input_type: 'number'
                    
                    CustomTextInput:
                        id: password_input
                        hint_text: 'Password'
                        password: True
                
                RoundedButton:
                    text: 'Register'
                    size_hint_y: None
                    height: dp(50)
                    background_color: colors('#4361ee')
                    color: colors('#ffffff')
                    bold: True
                    font_size: sp(16)
                    on_release: app.register(email_input.text, password_input.text, name_input.text, phone_input.text)

# Dashboard Screen
<DashboardScreen>:
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba: colors('#f8f9fa')
            Rectangle:
                pos: self.pos
                size: self.size
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(70)
            padding: dp(15), dp(10)
            canvas.before:
                Color:
                    rgba: colors('#ffffff')
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                text: 'My Bills'
                font_size: sp(22)
                bold: True
                color: colors('#212529')
                text_size: self.width, None
                halign: 'left'
            
            IconButton:
                text: '+'
                bg_color: colors('#4361ee')
                text_color: colors('#ffffff')
                font_size: sp(24)
                on_release: 
                    root.manager.get_screen('add_bill').clear_form()
                    root.manager.current = 'add_bill'
        
        BoxLayout:
            orientation: 'vertical'
            padding: dp(10)
            spacing: dp(10)
            
            Label:
                text: 'UPCOMING PAYMENTS'
                font_size: sp(12)
                color: colors('#6c757d')
                size_hint_y: None
                height: dp(30)
                text_size: self.width, None
                halign: 'left'
                padding: dp(10), 0
            
            ScrollView:
                BoxLayout:
                    id: bills_list
                    orientation: 'vertical'
                    spacing: dp(15)
                    padding: dp(5)
                    size_hint_y: None
                    height: self.minimum_height
        
        # This is the updated navigation bar code.
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(70)
            padding: dp(5)
            spacing: dp(5)
            canvas.before:
                Color:
                    rgba: colors('#ffffff')
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Button:
                id: btn_home
                text: 'Home'
                background_color: 0, 0, 0, 0
                color: colors('#6c757d')
                on_release: 
                    root.manager.current = 'dashboard'
                    root.update_nav_buttons()
            
            Button:
                id: btn_add
                text: 'Add'
                background_color: 0, 0, 0, 0
                color: colors('#6c757d')
                on_release: 
                    root.manager.get_screen('add_bill').clear_form()
                    root.manager.current = 'add_bill'
            
            Button:
                id: btn_settings
                text: 'Settings'
                background_color: 0, 0, 0, 0
                color: colors('#6c757d')
                on_release: 
                    root.manager.current = 'settings'
                    root.update_nav_buttons()

# Add/Edit Bill Screen
<AddBillScreen>:
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba: colors('#f8f9fa')
            Rectangle:
                pos: self.pos
                size: self.size
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(70)
            padding: dp(15), dp(10)
            canvas.before:
                Color:
                    rgba: colors('#ffffff')
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            IconButton:
                text: '←'
                bg_color: colors('#e9ecef')
                text_color: colors('#4361ee')
                on_release: root.manager.current = 'dashboard'
            
            Label:
                text: 'Edit Bill' if root.is_edit_mode else 'Add Bill'
                font_size: sp(22)
                bold: True
                color: colors('#212529')
                size_hint_x: 0.8
                text_size: self.width, None
                halign: 'center'
        
        ScrollView:
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(20)
                padding: dp(20)
                size_hint_y: None
                height: self.minimum_height
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    Label:
                        text: 'Bill Information'
                        font_size: sp(16)
                        bold: True
                        color: colors('#212529')
                        size_hint_y: None
                        height: dp(30)
                        text_size: self.width, None
                        halign: 'left'
                    
                    CustomTextInput:
                        id: bill_name
                        hint_text: 'Bill Name'
                    
                    CustomTextInput:
                        id: bill_amount
                        hint_text: 'Amount'
                        input_type: 'number'
                    
                    CustomTextInput:
                        id: bill_due_date
                        hint_text: 'Due Date (YYYY-MM-DD)'
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    Label:
                        text: 'Bill Details'
                        font_size: sp(16)
                        bold: True
                        color: colors('#212529')
                        size_hint_y: None
                        height: dp(30)
                        text_size: self.width, None
                        halign: 'left'
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'Category:'
                            size_hint_x: 0.4
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Spinner:
                            id: bill_category
                            text: 'utilities'
                            values: ['utilities', 'rent', 'insurance', 'subscription', 'loan', 'credit_card', 'other']
                            background_color: colors('#ffffff')
                            background_normal: ''
                            color: colors('#212529')
                            size_hint_x: 0.6
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'Frequency:'
                            size_hint_x: 0.4
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Spinner:
                            id: bill_frequency
                            text: 'monthly'
                            values: ['once', 'weekly', 'monthly', 'quarterly', 'yearly']
                            background_color: colors('#ffffff')
                            background_normal: ''
                            color: colors('#212529')
                            size_hint_x: 0.6
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'Voice Call Reminder:'
                            size_hint_x: 0.7
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Switch:
                            id: enable_call_switch
                            size_hint_x: None
                            width: dp(60)
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    Label:
                        text: 'Notes'
                        font_size: sp(16)
                        bold: True
                        color: colors('#212529')
                        size_hint_y: None
                        height: dp(30)
                        text_size: self.width, None
                        halign: 'left'
                    
                    TextInput:
                        id: bill_notes
                        hint_text: 'Additional notes...'
                        multiline: True
                        size_hint_y: None
                        height: dp(100)
                        padding: dp(10)
                        background_color: colors('#ffffff')
                        foreground_color: colors('#212529')
                        cursor_color: colors('#4361ee')
                
                RoundedButton:
                    text: 'UPDATE BILL' if root.is_edit_mode else 'SAVE BILL'
                    size_hint_y: None
                    height: dp(55)
                    background_color: colors('#4361ee')
                    color: colors('#ffffff')
                    bold: True
                    font_size: sp(16)
                    on_release: root.save_bill()

# Settings Screen
<SettingsScreen>:
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba: colors('#f8f9fa')
            Rectangle:
                pos: self.pos
                size: self.size
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(70)
            padding: dp(15), dp(10)
            canvas.before:
                Color:
                    rgba: colors('#ffffff')
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            IconButton:
                text: '←'
                bg_color: colors('#e9ecef')
                text_color: colors('#4361ee')
                on_release: root.manager.current = 'dashboard'
            
            Label:
                text: 'Settings'
                font_size: sp(22)
                bold: True
                color: colors('#212529')
                size_hint_x: 0.8
                text_size: self.width, None
                halign: 'center'
        
        ScrollView:
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(20)
                padding: dp(20)
                size_hint_y: None
                height: self.minimum_height
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    Label:
                        text: 'Reminder Channels'
                        font_size: sp(16)
                        bold: True
                        color: colors('#212529')
                        size_hint_y: None
                        height: dp(30)
                        text_size: self.width, None
                        halign: 'left'
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'WhatsApp'
                            size_hint_x: 0.8
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Switch:
                            id: whatsapp_switch
                            size_hint_x: None
                            width: dp(60)
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'Voice Call'
                            size_hint_x: 0.8
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Switch:
                            id: call_switch
                            size_hint_x: None
                            width: dp(60)
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'SMS'
                            size_hint_x: 0.8
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Switch:
                            id: sms_switch
                            size_hint_x: None
                            width: dp(60)
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'App Notifications'
                            size_hint_x: 0.8
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        Switch:
                            id: notification_switch
                            size_hint_x: None
                            width: dp(60)
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    Label:
                        text: 'Reminder Timing'
                        font_size: sp(16)
                        bold: True
                        color: colors('#212529')
                        size_hint_y: None
                        height: dp(30)
                        text_size: self.width, None
                        halign: 'left'
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'Days Before Due:'
                            size_hint_x: 0.6
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        TextInput:
                            id: days_before_input
                            text: '3'
                            size_hint_x: 0.4
                            input_type: 'number'
                            multiline: False
                            background_color: colors('#ffffff')
                            foreground_color: colors('#212529')
                            padding: dp(10)
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: dp(50)
                        spacing: dp(10)
                        
                        Label:
                            text: 'Preferred Time:'
                            size_hint_x: 0.6
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'center'
                        
                        TextInput:
                            id: preferred_time_input
                            text: '09:00'
                            size_hint_x: 0.4
                            multiline: False
                            background_color: colors('#ffffff')
                            foreground_color: colors('#212529')
                            padding: dp(10)
                
                RoundedButton:
                    text: 'SAVE SETTINGS'
                    size_hint_y: None
                    height: dp(55)
                    background_color: colors('#4361ee')
                    color: colors('#ffffff')
                    bold: True
                    font_size: sp(16)
                    on_release: root.save_settings()
                
                CardLayout:
                    orientation: 'vertical'
                    spacing: dp(15)
                    
                    Label:
                        text: 'Test Reminders'
                        font_size: sp(16)
                        bold: True
                        color: colors('#212529')
                        size_hint_y: None
                        height: dp(30)
                        text_size: self.width, None
                        halign: 'left'
                    
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(10)
                        size_hint_y: None
                        height: dp(50)
                        
                        RoundedButton:
                            text: 'TEST WHATSAPP'
                            size_hint_x: 0.5
                            background_color: colors('#25d366')
                            color: colors('#ffffff')
                            bold: True
                            font_size: sp(14)
                            on_release: root.test_reminder('whatsapp')
                        
                        RoundedButton:
                            text: 'TEST CALL'
                            size_hint_x: 0.5
                            background_color: colors('#4361ee')
                            color: colors('#ffffff')
                            bold: True
                            font_size: sp(14)
                            on_release: root.test_reminder('call')
                
                RoundedButton:
                    text: 'LOGOUT'
                    size_hint_y: None
                    height: dp(55)
                    background_color: colors('#e63946')
                    color: colors('#ffffff')
                    bold: True
                    font_size: sp(16)
                    on_release: root.logout()
